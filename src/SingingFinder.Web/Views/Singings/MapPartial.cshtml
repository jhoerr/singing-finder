@using Jmelosegui.Mvc.GoogleMap
@using Microsoft.Azure
@using SingingFinder.Core
@using WebGrease.Css.Extensions
@model SingingFinder.Web.Models.SingingsViewModel

@{

    var cookie = Request.Cookies["myMapCookie"];
    var value = cookie == null ? "" : cookie.Value ?? "";
    double lat=0.0, lng = 0.0;
    int zoom = 6; // default zoom
    var parts = value.Split('_');
    if (parts.Length == 3)
    {
        double.TryParse(parts[0], out lat);
        double.TryParse(parts[1], out lng);
        int.TryParse(parts[2], out zoom);
    }

    var count = Model.Events.Count();
    var bookClause = Model.Book == Book.All ? string.Empty : Model.Book + " ";
    var isAreClause = count == 1 ? "is" : "are";
    var countClause = count == 0 ? "no" : count.ToString();
    var singingClause = count == 1 ? "singing" : "singings";
}

<p>There @(isAreClause) @(countClause) @(bookClause)@(singingClause) between @Model.Start.ToString("ddd, MMM dd yyyy") and @Model.End.ToString("ddd, MMM dd yyyy").</p>

@(Html.GoogleMap()
      .ApiKey(CloudConfigurationManager.GetSetting("GoogleMaps.ApiKey"))
      .Name("map")
      .Height(600)
      .Zoom(zoom)
      .Center(center =>
      {
          if (lat == 0.0 && lng == 0.0)
          {
              center.UseCurrentPosition();
          }
          else
          {
              center.Latitude(lat).Longitude(lng);
          }
      })
      .ClientEvents(events => events
        .OnMapDragEnd("saveMapState")
        .OnZoomChanged("saveMapState"))
      .Markers(factory =>
          Model.Events.ForEach(marker =>
              factory.Add()
                  .Latitude(marker.Singing.Latitude)
                  .Longitude(marker.Singing.Longitude)
                  .Title(marker.Singing.Name)
                  .Window(window =>
                      window.Add()
                          .MaxWidth(600)
                          .DisableAutoPan(false)
                          .Content(
                              @<text>
                                  <div>
                                      @if (string.IsNullOrWhiteSpace(marker.Singing.SingingUrl))
                                      {
                                          <h2>@marker.Singing.Name</h2>
                                      }
                                      else
                                      {
                                        <h2><a href="@marker.Singing.SingingUrl" target="_blank">@marker.Singing.Name</a></h2>
                                      }
                                      <div id="bodyContent">
                                          @if (marker.Days.Start == marker.Days.End)
                                          {
                                              <p><b>@marker.Days.Start.ToString("ddd, MMM dd yyyy")</b> (@marker.Singing.Day in @marker.Singing.Month).</p>
                                          }
                                          else
                                          {
                                              <p><b>@marker.Days.Start.ToString("ddd, MMM dd yyyy") - @marker.Days.End.ToString("ddd, MMM dd yyyy")</b> (@marker.Singing.Day in @marker.Singing.Month).</p>
                                          }
                                          <p><b>Book:</b> @marker.Singing.Book</p>
                                          <p><b>Info:</b> @Html.Raw(marker.Singing.Info)</p>
                                          <p><b>Location:</b> @marker.Singing.Location</p>
                                          <p><a href="@Html.Raw(marker.Singing.LocationUrl)" target="_blank">Get Directions in Google Maps</a>
                                          </p>
                                      </div>
                                  </div>
                               </text>
                          )
                  )
              )
      ))

@(Html.GoogleMap().ScriptRegistrar())